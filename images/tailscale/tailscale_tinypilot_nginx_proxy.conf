server {
    listen [::]:9090;
    listen 9090;
    server_name tinypilot.tail2dac17.ts.net;

    # --- resolver를 서버 블록 전체에 적용 ---
    # Nginx가 Tailscale DNS가 아닌 Docker DNS(127.0.0.11)를 사용하도록 설정합니다.
    resolver 127.0.0.11 valid=5s; # <-- 추가된 부분

    # --- 각 프록시 목적지를 위한 변수 설정 ---
    set $tinypilot_socket_upstream http://tinypilot;      # <-- 추가된 부분
    set $ustreamer_upstream        http://ustreamer:8001;      # <-- 추가된 부분
    set $tinypilot_main_upstream   http://tinypilot:8000/; # <-- 추가된 부분
    set $tinypilot2_upstream       http://tinypilot:8000;      # <-- 추가된 부분

    root /opt/tinypilot;
    index index.html;

    proxy_buffers 16 16k;
    proxy_buffer_size 16k;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;

    location /socket.io {
        proxy_pass $tinypilot2_upstream; # <-- 수정된 부분

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /state {
        proxy_pass $ustreamer_upstream; # <-- 수정된 부분
    }

    location /stream {
        postpone_output 0;
        proxy_buffering off;
        proxy_ignore_headers X-Accel-Buffering;
        proxy_pass $ustreamer_upstream; # <-- 수정된 부분
    }

    location /snapshot {
        proxy_pass $ustreamer_upstream; # <-- 수정된 부분
    }

    location / {
        proxy_pass $tinypilot_main_upstream; # <-- 수정된 부분
    }

    location ~* ^/.+\.(html|js|js.map|css|woff|woff2)$ {
        proxy_pass $tinypilot2_upstream; # <-- 수정된 부분
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Last-Modified $date_gmt;
        add_header Cache-Control 'public, max-age=10s';
    }

    location ~* ^/.+\.(jpg|jpeg|png|ico)$ {
        proxy_pass $tinypilot2_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Last-Modified $date_gmt;
        add_header Cache-Control 'public, max-age=10s';
    }
}
